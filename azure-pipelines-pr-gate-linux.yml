#Use matrix to speed up the build process
strategy:
  matrix:
    TARGET_MDE_CPU:
      Build.Pkgs: 'MdePkg UefiCpuPkg'
    TARGET_MDEMODULE:
      Build.Pkgs: 'MdeModulePkg'
    TARGET_OTHER:
      Build.Pkgs: 'MsUnitTestPkg NetworkPkg PcAtChipsetPkg'
    TARGET_SECURITY:
      Build.Pkgs: 'SecurityPkg'

variables:
  GCC_AARCH_PREFIX: bin/aarch64-linux-gnu-
  GCC_ARM_PREFIX: bin/arm-linux-gnueabihf-

workspace:
  clean: all

steps:
- checkout: self
  clean: true

- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.7.x'
    architecture: 'x64'

- script: pip3 install -r requirements.txt --upgrade
  displayName: 'Install/Upgrade mu_build'

#Build repo
- task: CmdLine@1
  displayName: Build and Test $(Build.Pkgs)
  inputs:
    filename: mu_build
    arguments: -c ci.mu.yaml --force-git TOOL_CHAIN_TAG=GCC5 -p $(Build.Pkgs)

# Publish Test Results to Azure Pipelines/TFS
- task: PublishTestResults@2
  displayName: 'Publish junit test results'
  continueOnError: true
  condition: succeededOrFailed()
  inputs:
    testResultsFormat: 'JUnit' # Options: JUnit, NUnit, VSTest, xUnit
    testResultsFiles: 'Build/BuildLogs/TestSuites.xml'
    #searchFolder: '$(System.DefaultWorkingDirectory)' # Optional
    mergeTestResults: true # Optional
    #testRunTitle: # Optional
    #buildPlatform: # Optional
    #buildConfiguration: # Optional
    publishRunAttachments: true # Optional


# Publish Build Artifacts
# Publish build artifacts to Azure Artifacts/TFS or a file share
- task: PublishBuildArtifacts@1
  displayName: 'Publish build logs'
  continueOnError: true
  condition: succeededOrFailed()
  inputs:
    pathtoPublish: 'Build/BuildLogs'
    artifactName: 'Build Logs $(Build.Pkgs)'
    #publishLocation: 'Container' # Options: container, filePath
    #targetPath: # Required when publishLocation == FilePath
    #parallel: false # Optional
    #parallelCount: # Optional
